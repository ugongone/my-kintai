# 勤怠編集・削除機能実装

## 概要
勤怠データ（time_entries）の編集・削除機能を実装しました。月次実績ページから、すべての打刻エントリーを編集・削除できるようにしました。

## 実装内容

### 1. 新規作成コンポーネント

#### ConfirmDialog (`src/components/ui/ConfirmDialog.tsx`)
削除確認用の汎用ダイアログコンポーネント。

**特徴:**
- Modalコンポーネントをベースに構築
- 確認・キャンセルの2ボタン
- `variant`プロパティで色分け（danger: 赤、warning: 黄色）
- 削除以外にも再利用可能な設計

**Props:**
```typescript
interface ConfirmDialogProps {
  isOpen: boolean
  onClose: () => void
  onConfirm: () => void
  title: string
  message: string
  confirmText?: string  // デフォルト: "確認"
  cancelText?: string   // デフォルト: "キャンセル"
  variant?: 'danger' | 'warning'  // デフォルト: "warning"
}
```

### 2. 既存コンポーネントの拡張

#### ManualEntryModal (`src/components/dashboard/ManualEntryModal.tsx`)
手動打刻モーダルを編集モードにも対応するよう拡張。

**変更点:**
- `mode` props追加（'create' | 'edit'、デフォルト: 'create'）
- `initialData` props追加（編集時の初期値）
- `useEffect`で`initialData`変更時にstateを更新
- タイトルを動的に変更（編集時: "打刻を編集"、作成時: "手動打刻"）
- ボタンテキストを動的に変更（編集時: "更新"、作成時: "登録"）

**新しいProps:**
```typescript
mode?: 'create' | 'edit'
initialData?: {
  id: string
  date: string
  time: string
  entryType: EntryType
  note?: string
}
```

#### HistoryTable (`src/components/history/HistoryTable.tsx`)
日次統計テーブルに個別エントリー表示と編集・削除機能を追加。

**変更点:**
- 'use client'ディレクティブ追加（状態管理のため）
- 展開状態管理：`useState<Set<string>>`で展開されている日付を管理
- 行クリックで展開/折りたたみをトグル
- 展開時に`stat.entries`（個別打刻エントリー）を表示
- 各エントリーに編集・削除アイコンボタンを配置
- ChevronDown/ChevronRight、Pencil、Trash2アイコンを使用

**新しいProps:**
```typescript
onEditEntry: (entry: TimeEntry) => void
onDeleteEntry: (entry: TimeEntry) => void
```

**UI構造:**
```
日付行（クリック可能）
  [>] 12/01 | 完了 | 09:00 | 18:00 | 1:00 | 8:00
  ↓ クリックで展開
  [v] 12/01 | 完了 | 09:00 | 18:00 | 1:00 | 8:00
    └─ [業務開始] 09:00 | - | [編集][削除]
    └─ [休憩開始] 12:00 | - | [編集][削除]
    └─ [休憩終了] 13:00 | - | [編集][削除]
    └─ [業務終了] 18:00 | - | [編集][削除]
```

#### 月次実績ページ (`src/app/(authenticated)/history/page.tsx`)
編集・削除機能を統合。

**変更点:**
1. **状態管理の追加**
   - `editingEntry`: 編集中のエントリー
   - `deletingEntry`: 削除対象のエントリー
   - `isEditModalOpen`: 編集モーダルの開閉状態
   - `isDeleteDialogOpen`: 削除確認ダイアログの開閉状態

2. **イベントハンドラの追加**
   - `handleEditEntry()`: 編集モーダルを開く
   - `handleUpdateEntry()`: 編集を実行（updateEntry呼び出し）
   - `handleDeleteClick()`: 削除確認ダイアログを開く
   - `handleDeleteConfirm()`: 削除を実行（deleteEntry呼び出し）
   - `getEntryTypeLabel()`: 打刻種別の日本語ラベルを取得

3. **コンポーネントの追加**
   - `ManualEntryModal`（編集モード）
   - `ConfirmDialog`（削除確認）

4. **HistoryTableへのprops追加**
   - `onEditEntry={handleEditEntry}`
   - `onDeleteEntry={handleDeleteClick}`

## 技術的な設計

### データフロー

#### 編集フロー
```
HistoryTable（展開された行）
  ↓ (ユーザーが編集ボタンクリック)
onEditEntry(entry: TimeEntry)
  ↓
history/page.tsx
  - setEditingEntry(entry)
  - setIsEditModalOpen(true)
  ↓
ManualEntryModal (mode="edit", initialData)
  ↓ (ユーザーが更新ボタンクリック)
onSubmit(data)
  ↓
handleUpdateEntry
  - updateEntry(id, updates)
  ↓
useTimeEntries.updateEntry
  - Supabase更新
  - fetchEntries() 自動実行
  ↓
UI自動更新
```

#### 削除フロー
```
HistoryTable（展開された行）
  ↓ (ユーザーが削除ボタンクリック)
onDeleteEntry(entry: TimeEntry)
  ↓
history/page.tsx
  - setDeletingEntry(entry)
  - setIsDeleteDialogOpen(true)
  ↓
ConfirmDialog表示
  ↓ (ユーザーが削除ボタンクリック)
onConfirm()
  ↓
handleDeleteConfirm
  - deleteEntry(id)
  ↓
useTimeEntries.deleteEntry
  - Supabase削除
  - fetchEntries() 自動実行
  ↓
UI自動更新
```

### 認可とセキュリティ

- Supabase Row Level Security（RLS）により、ユーザーは自分のデータのみ編集・削除可能
- `auth.uid() = user_id`でフィルタされるため、他人のデータにアクセス不可
- クライアント側での追加の権限チェックは不要

### エラーハンドリング

- try-catchでネットワークエラーを捕捉
- エラー時はalert表示
- モーダル/ダイアログは開いたまま（再試行可能）

## Q&A

### Q1: なぜManualEntryModalを新規作成ではなく拡張したのか？
**A:** 新規作成と編集で同じフォーム構造を使用するため、コードの重複を避け、UI/UXの一貫性を保つため。`mode` propsで切り替えるだけでシンプルに両方の機能を実現できる。

### Q2: なぜHistoryTableで行を展開する方式を採用したのか？
**A:** `DailyStat`型に既に`entries: TimeEntry[]`が含まれているため、日次統計と個別エントリーの両方を同じテーブルで扱える。日付行をクリックするだけで詳細が見られる直感的なUI。

### Q3: なぜConfirmDialogを汎用的に作ったのか？
**A:** 削除以外にも確認ダイアログが必要なケース（例：設定のリセット、データのクリアなど）に再利用できるようにするため。`variant`プロパティで色分けも可能。

### Q4: ダッシュボードには編集・削除機能を追加しないのか？
**A:** 最小変更アプローチでは省略。ダッシュボードは概要表示に特化し、詳細な編集は月次実績ページで行う設計。必要に応じて将来追加可能。

### Q5: 編集・削除後にUIが自動更新されるのはなぜか？
**A:** `useTimeEntries`フックの`updateEntry()`と`deleteEntry()`が内部で`fetchEntries()`を呼び出すため。Supabaseのデータ更新後、自動的に最新データを取得してstateを更新する。

## ファイル変更一覧

### 新規作成
- `src/components/ui/ConfirmDialog.tsx`

### 変更
- `src/components/dashboard/ManualEntryModal.tsx`
- `src/components/history/HistoryTable.tsx`
- `src/app/(authenticated)/history/page.tsx`

### 参照のみ（変更なし）
- `src/hooks/useTimeEntries.ts`（updateEntry, deleteEntryが既に実装済み）
- `src/lib/utils/dailyStats.ts`（DailyStat.entriesを活用）
- `src/types/database.ts`（TimeEntry, EntryType型を使用）
