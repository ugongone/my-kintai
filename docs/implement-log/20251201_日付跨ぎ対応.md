## 概要

夜勤など日付をまたぐ勤務に対応するため、work_dateカラムを追加し、勤務の論理的な開始日を基準に集計するように変更しました。

## 実装内容

### 1. データベーススキーマ変更

`work_date`カラム（DATE型）を`time_entries`テーブルに追加しました。

- 0-4時台のエントリーは前日の勤務として扱う
- 5-23時台のエントリーは当日の勤務として扱う
- 既存データに対しても同様のロジックでwork_dateを自動計算

**マイグレーションファイル**: `supabase/migrations/20251201000000_add_work_date.sql`

### 2. work_date計算関数の実装

`src/lib/utils/workDate.ts`に`calculateWorkDate`関数を実装しました。

- 入力: `Date`オブジェクト（entry_time）
- 出力: `string`（YYYY-MM-DD形式のwork_date）
- ロジック: 時刻が0-4時の場合は前日、5-23時の場合は当日

### 3. 打刻ロジックの修正

`src/hooks/useTimeEntries.ts`を修正しました。

- `addEntry`: 新規打刻時にwork_dateを自動計算して保存
- `updateEntry`: 打刻時刻を編集した場合、work_dateも再計算

### 4. 日次統計計算ロジックの修正

`src/lib/utils/dailyStats.ts`の`calculateDailyStats`関数を修正しました。

**変更前**: `entry_time`から日付キーを生成
**変更後**: `work_date`を直接使用

これにより、23時〜翌1時のような日付跨ぎ勤務も、開始日に正しく集計されます。

### 5. バリデーションの実装

`src/lib/utils/validation.ts`に`validateNewEntry`関数を実装しました。

**チェック項目**:
- 初回打刻が「業務開始」であること
- 状態遷移が正しいこと（例: 業務中→休憩開始は可、業務中→業務開始は不可）
- 過去の時刻に打刻していないこと
- 12時間以上の長時間勤務の場合は警告表示

**エラーレベル**:
- `error`: 打刻を中断
- `warning`: 確認ダイアログを表示し、ユーザーが選択

### 6. UIでのバリデーション統合

`src/app/(authenticated)/page.tsx`の各打刻関数にバリデーションを統合しました。

- リアルタイム打刻（業務開始、業務終了、休憩開始、休憩終了）
- 手動打刻

### 7. TypeScript型定義の更新

`src/types/database.ts`の`TimeEntry`型に`work_date`フィールドを追加しました。

## 動作例

### 通常の日中勤務

```
12/1 09:00 業務開始 → work_date: 2025-12-01
12/1 18:00 業務終了 → work_date: 2025-12-01
→ 12/1の日次統計に9時間として計上
```

### 日付跨ぎの夜勤

```
12/1 23:00 業務開始 → work_date: 2025-12-01
12/2 01:00 業務終了 → work_date: 2025-12-01
→ 12/1の日次統計に2時間として計上
```

### 深夜休憩あり

```
12/1 22:00 業務開始 → work_date: 2025-12-01
12/2 00:00 休憩開始 → work_date: 2025-12-01
12/2 00:30 休憩終了 → work_date: 2025-12-01
12/2 03:00 業務終了 → work_date: 2025-12-01
→ 12/1の日次統計に実働4.5時間、休憩0.5時間として計上
```

### 5時境界テスト

```
12/2 04:59 業務開始 → work_date: 2025-12-01（前日扱い）
12/2 05:00 業務開始 → work_date: 2025-12-02（当日扱い）
```

## 影響範囲

### 変更が必要だったファイル

**新規作成**:
1. `supabase/migrations/20251201000000_add_work_date.sql`
2. `src/lib/utils/workDate.ts`
3. `src/lib/utils/validation.ts`
4. `docs/implement-log/20251201_日付跨ぎ対応.md`

**修正**:
1. `src/types/database.ts`
2. `src/hooks/useTimeEntries.ts`
3. `src/lib/utils/dailyStats.ts`
4. `src/app/(authenticated)/page.tsx`

### 変更不要だったファイル

- UIコンポーネント（表示ロジックは変更なし）
- 認証関連
- 設定画面

### 既存データの互換性

- マイグレーション実行時に既存データの`work_date`を自動計算
- 日中勤務データは影響なし（そのまま当日として扱われる）

## Q&A

### Q1: 5時を境界にした理由は？

A: 一般的な夜勤の慣習として、深夜0-5時は前日の勤務継続とみなされることが多いため。例えば、23時に開始した夜勤が翌朝4時に終了した場合、それは開始日の勤務として扱われる方が自然です。

### Q2: 既存データへの影響は？

A: マイグレーションで自動的にwork_dateが計算・設定されます。日中勤務データ（5時以降の打刻）は同じ日付がwork_dateとして設定されるため、集計結果に影響はありません。

### Q3: UIの変更は必要？

A: 不要。打刻入力UIは変更せず、バックエンドの計算ロジックのみを変更しました。ユーザーは従来通り日付と時刻を入力するだけで、システムが自動的に適切なwork_dateを計算します。

### Q4: バリデーションはどのように機能する？

A: 打刻前にリアルタイムでチェックを実行します。
- エラー（状態遷移違反など）: 打刻を中断し、エラーメッセージを表示
- 警告（12時間以上の勤務など）: 確認ダイアログを表示し、ユーザーが続行するか選択

### Q5: work_dateを手動で変更できる？

A: 現在の実装では、work_dateはentry_timeから自動計算されるため、直接編集はできません。打刻時刻を編集すると、それに応じてwork_dateも自動的に再計算されます。
