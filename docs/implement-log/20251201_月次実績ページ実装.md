# 20251201_月次実績ページ実装

## 概要

フェーズ7として、月次実績ページを実装しました。このページでは、ユーザーが月ごとの稼働履歴を確認でき、CSV形式でエクスポートできます。

## 実装内容

### 1. useTimeEntriesフックの拡張

**ファイル**: [src/hooks/useTimeEntries.ts](../../src/hooks/useTimeEntries.ts)

- 年月を指定して打刻データを取得できるように拡張
- オプショナルパラメータ `year`, `month` を追加
- デフォルトでは現在の年月のデータを取得

```typescript
export function useTimeEntries(year?: number, month?: number) {
  // 指定された年月、または現在の年月のデータを取得
  const targetYear = year ?? now.getFullYear()
  const targetMonth = month ?? now.getMonth()
  // ...
}
```

### 2. 日次統計計算ユーティリティの作成

**ファイル**: [src/lib/utils/dailyStats.ts](../../src/lib/utils/dailyStats.ts)

打刻データから日ごとの統計を計算する機能を実装：

- **DailyStat型**: 日ごとの統計データの型定義
  - `date`: 日付（YYYY-MM-DD形式）
  - `dateStr`: 表示用日付（M/D形式）
  - `workStart`: 開始時刻
  - `workEnd`: 終了時刻
  - `breakMinutes`: 休憩時間（分）
  - `workMinutes`: 実働時間（分）
  - `status`: ステータス（complete / in_progress / no_data）

- **calculateDailyStats関数**: 打刻エントリーから日次統計を計算
  - 日付ごとにエントリーをグループ化
  - 業務開始〜終了、休憩時間を計算
  - 稼働中の場合は現在時刻までの時間を計算

- **formatMinutesToHours関数**: 分を時間:分形式に変換

### 3. MonthSelectorコンポーネント

**ファイル**: [src/components/history/MonthSelector.tsx](../../src/components/history/MonthSelector.tsx)

月を選択するUIコンポーネント：

- 前月・次月への移動ボタン
- 現在の年月表示
- 現在の月より未来には移動できない制限

### 4. HistoryTableコンポーネント

**ファイル**: [src/components/history/HistoryTable.tsx](../../src/components/history/HistoryTable.tsx)

日次統計を表示するテーブルコンポーネント：

- 日付、ステータス、開始/終了時刻、休憩時間、実働時間を表示
- ステータスに応じたバッジ表示（完了・稼働中・データなし）
- データがない場合のメッセージ表示

### 5. 月次実績ページ

**ファイル**: [src/app/(authenticated)/history/page.tsx](../../src/app/(authenticated)/history/page.tsx)

すべてのコンポーネントを統合したメインページ：

- **月選択機能**: MonthSelectorで年月を選択
- **統計サマリー表示**: 総稼働時間と稼働日数を表示
- **履歴テーブル**: HistoryTableで日次データを表示
- **CSV出力機能**:
  - ダウンロードボタンをクリックでCSVファイルを生成
  - BOM付きUTF-8で日本語に対応
  - ファイル名: `勤怠記録_YYYY年MM月.csv`
  - ヘッダー: 日付、ステータス、開始時刻、終了時刻、休憩時間、実働時間

### 6. 主な機能

1. **月次データの表示**
   - 選択した月の全日の打刻データを表示
   - 日ごとの開始時刻、終了時刻、休憩時間、実働時間を計算

2. **月の切り替え**
   - 前月・次月ボタンで月を移動
   - 現在の月より先には進めない

3. **統計サマリー**
   - 総稼働時間（時間単位）
   - 稼働日数（実働時間が0より大きい日数）

4. **CSV出力**
   - 日次データをCSV形式でエクスポート
   - Excel等で開くことを想定したBOM付きUTF-8エンコーディング

## Q&A

### Q1: useTimeEntriesフックに年月パラメータを追加した理由は？

A: ダッシュボードでは現在の月のデータのみを扱いますが、月次実績ページでは過去の月のデータも取得する必要があるためです。オプショナルパラメータにすることで、既存のダッシュボードコードを変更せずに機能を拡張できます。

### Q2: DailyStatの`status`フィールドが持つ3つの状態の違いは？

A:
- `complete`: 業務開始と業務終了の打刻が両方ある完結した日
- `in_progress`: 業務開始はあるが業務終了がない、現在稼働中の日
- `no_data`: 打刻データがない日（現在は使用されていないが、将来的にカレンダー表示等で利用可能）

### Q3: calculateDailyStats関数で稼働時間を計算する際の注意点は？

A:
1. エントリーを時系列順にソート
2. work_start → break_start → break_end → work_end の順で処理
3. 休憩時間は複数回発生する可能性があるため累積
4. 実働時間 = 総業務時間 - 休憩時間
5. 稼働中（work_endがない）場合は現在時刻までを計算

### Q4: CSV出力でBOMを付加している理由は？

A: BOM（Byte Order Mark）を付加することで、ExcelなどのアプリケーションがUTF-8エンコーディングを正しく認識し、日本語が文字化けせずに表示されるようにするためです。

### Q5: MonthSelectorで次月ボタンを無効化する条件は？

A: 現在の年月と選択中の年月が一致する場合、次月ボタンを無効化します。これにより、未来の月のデータを表示しようとすることを防ぎます。
