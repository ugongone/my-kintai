# フェーズ2: Supabaseセットアップ 実装ログ

実施日: 2025-11-30

## 実施内容

### 2.1 データベーススキーマ作成

[supabase/migrations/20251130000000_initial_schema.sql](../../supabase/migrations/20251130000000_initial_schema.sql) を作成しました。

#### time_entries テーブル
打刻記録を格納するテーブル:

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー（自動生成） |
| user_id | UUID | ユーザーID（auth.usersへの外部キー） |
| entry_type | TEXT | 打刻種別: `work_start`, `work_end`, `break_start`, `break_end` |
| timestamp | TIMESTAMPTZ | 打刻日時 |
| note | TEXT | 備考（任意） |
| created_at | TIMESTAMPTZ | レコード作成日時（自動） |
| updated_at | TIMESTAMPTZ | レコード更新日時（自動更新） |

**インデックス**:
- `idx_time_entries_user_id` - user_idでの検索を高速化
- `idx_time_entries_timestamp` - 日時範囲での検索を高速化

#### settings テーブル
ユーザーごとの設定を格納するテーブル:

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー（自動生成） |
| user_id | UUID | ユーザーID（ユニーク、auth.usersへの外部キー） |
| hourly_wage | INTEGER | 時給（円）、デフォルト: 1000 |
| created_at | TIMESTAMPTZ | レコード作成日時（自動） |
| updated_at | TIMESTAMPTZ | レコード更新日時（自動更新） |

### 2.2 Row Level Security (RLS) ポリシー

両テーブルにRLSを有効化し、以下のポリシーを設定:

**time_entries テーブル**:
- SELECT: ユーザーは自分の打刻記録のみ閲覧可能
- INSERT: ユーザーは自分の打刻記録のみ作成可能
- UPDATE: ユーザーは自分の打刻記録のみ更新可能
- DELETE: ユーザーは自分の打刻記録のみ削除可能

**settings テーブル**:
- SELECT: ユーザーは自分の設定のみ閲覧可能
- INSERT: ユーザーは自分の設定のみ作成可能
- UPDATE: ユーザーは自分の設定のみ更新可能

すべてのポリシーで `auth.uid() = user_id` を使用してアクセス制御を実施。

### 2.3 自動更新トリガー

`updated_at` カラムを自動更新するためのトリガー関数を作成:
- `update_updated_at_column()` 関数を定義
- `time_entries` テーブルと `settings` テーブルにトリガーを設定
- レコード更新時に自動的に `updated_at` を現在時刻に更新

### 2.4 Supabaseセットアップガイド作成

[docs/supabase-setup-guide.md](../supabase-setup-guide.md) を作成しました。

このガイドには以下が含まれます:
1. **Supabaseプロジェクト作成手順**
   - アカウント作成からプロジェクト設定まで
   - Project URLとAnon Keyの取得方法
   - `.env.local` ファイルの設定手順

2. **データベーススキーマ構築手順**
   - SQLエディタでマイグレーションSQLを実行する方法
   - テーブル作成の確認方法

3. **Google OAuth設定手順**
   - Google Cloud Consoleでのプロジェクト作成
   - OAuth同意画面の設定
   - OAuthクライアントIDの作成
   - Supabaseでの認証プロバイダー設定
   - リダイレクトURLの設定

4. **トラブルシューティング**
   - よくあるエラーと対処法

## 技術的なポイント

### カスケード削除
`ON DELETE CASCADE` を設定することで、ユーザーが削除された場合に関連する打刻記録と設定も自動的に削除されます。

### TIMESTAMPTZ型の使用
タイムゾーン対応のタイムスタンプ型を使用することで、異なるタイムゾーンでのアクセスにも正確に対応できます。

### CHECK制約
`entry_type` カラムに CHECK制約を設定することで、不正な値の挿入を防ぎます。

### RLSによるセキュリティ
Row Level Securityにより、アプリケーションコード側でのアクセス制御が不要になり、データベースレベルで安全性を確保できます。

## 次のステップ

ユーザーは[docs/supabase-setup-guide.md](../supabase-setup-guide.md) の手順に従ってSupabaseプロジェクトをセットアップします。

セットアップ完了後、フェーズ3の認証機能実装に進みます:
- Supabaseクライアント設定
- ログインページ作成
- 認証ミドルウェア実装
- 認証フック作成

## ファイル一覧

- [supabase/migrations/20251130000000_initial_schema.sql](../../supabase/migrations/20251130000000_initial_schema.sql)
- [docs/supabase-setup-guide.md](../supabase-setup-guide.md)
